# Mindflow 架构设计文档 v1.0

> **基于**: 2026-01-18 架构讨论
> **版本**: v1.0  
> **状态**: 核心架构已确定

---

## 🎯 项目定位

**Mindflow 是一个智能体操作系统 (Agent OS)**

运行在 Windows/macOS/Linux 之上,专注于个人生活场景的深度优化。

### 核心特点

- 🧠 **知识库驱动** - 以知识图谱为认知基础
- 🔄 **自我演化** - Skills 自动学习和优化
- 🏠 **生活场景** - 深度优化个人日常使用
- 🔐 **隐私优先** - 本地存储,离线可用

---

## 🏗️ 核心架构

### 操作系统抽象

```
智能体操作系统 = 输入 + 输出 + 资源调度
```

这个抽象适用于所有操作系统:
- 计算机操作系统 (Windows/Linux)
- 生物操作系统 (人脑)
- **智能体操作系统 (Mindflow)**

### 三要素架构

```
┌─────────────────────────────────────┐
│  输入层 (Input Layer)                │
│  - 多模态: 语音/视觉/文本            │
│  - 实时流: 24/7 持续感知             │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  知识库 (Knowledge Base)             │
│  - 贯穿全局的认知基础                │
│  - 理解/决策/学习                    │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  输出层 (Output Layer)               │
│  - 对话/行动                         │
│  - 复盘/计划                         │
│  - Skills 演化                       │
└─────────────────────────────────────┘
```

**关键**: 知识库不是"资源层"的一部分,而是贯穿全局的认知基础

---

## 🧠 知识库设计

### 核心地位

```
        知识库 (Knowledge Base)
           ↓  ↑
输入 → 理解/决策 → 输出
     (基于知识库)
```

**知识库 = 系统和用户对世界的理解模型**

### 三层结构

```
┌─────────────────────────────────────┐
│  L1: 方法论层 (Methodologies)        │
│  - 抽象原则,作为真理存在             │
│  - 指导 Skills 的调用和增改          │
│  - 数量: 10-50 个                    │
│  - 示例: "简单优于复杂"              │
└─────────────────────────────────────┘
           ↓ 指导
┌─────────────────────────────────────┐
│  L2: Skills 层                       │
│  - 可执行步骤,特定场景               │
│  - 可以调用其他 Skills               │
│  - 数量: 100-500 个                  │
│  - 示例: "CSV文件处理"               │
└─────────────────────────────────────┘
           ↓ 应用
┌─────────────────────────────────────┐
│  L3: 副产品层 (Artifacts)            │
│  - 叶子节点,可复用资源               │
│  - 函数/代码块级别                   │
│  - 数量: 无限                        │
│  - 示例: parse_csv() 函数            │
└─────────────────────────────────────┘
```

### 结构特点

**DAG 结构 (有向无环图)**
- 一个副产品可以属于多个 Skills
- Skills 之间可以跨分支调用
- 不是严格树形,更灵活

**关键设计原则**
1. 向上聚合: 从副产品提炼 Skills,从 Skills 提炼方法论
2. 向下应用: 方法论指导 Skills,Skills 应用到实例
3. 横向限制: 同层关联最小化,禁止相似度关联

---

## 📊 节点类型

### 方法论节点 (Methodology)

```python
Methodology {
    id: str
    name: str
    description: str
    principles: List[str]
    
    # 关系
    guided_skills: List[str]  # 指导哪些 Skills
    
    # 元数据
    status: NodeStatus  # active/deprecated/archived/pending
    created_at: datetime
    updated_at: datetime
    confidence: float  # 0-1
}

enum NodeStatus { ACTIVE, DEPRECATED, ARCHIVED, PENDING }
```

**特征**:
- 数量少 (10-50个)
- 高度抽象
- 作为真理存在
- 指导性而非执行性

**示例**:
- "简单优于复杂"
- "优先使用标准库"
- "保持代码可读性"

### Skills 节点

```python
Skill {
    id: str
    name: str
    description: str
    instructions: str
    
    # 关系
    parent_methodologies: List[str]  # 受哪些方法论指导
    called_skills: List[str]         # 调用哪些 Skills
    artifacts: List[str]             # 包含哪些副产品
    
    # 元数据
    success_rate: float
    usage_count: int
    created_from: List[str]  # 从哪些事件学习
    created_at: datetime
    updated_at: datetime
}
```

**特征**:
- 可执行步骤
- 特定场景
- 可以调用其他 Skills
- 持续演化

**示例**:
- "Python 数据处理"
- "CSV 文件解析"
- "错误处理模式"

### 副产品节点 (Artifact)

```python
Artifact {
    id: str
    name: str
    type: ArtifactType  # Code/Function/Template/Document/Config
    content: str
    
    # 关系
    parent_skills: List[str]  # 属于哪些 Skills
    
    # 元数据
    usage_count: int
    tags: List[str]
    created_at: datetime
}
```

**类型**:
- Code Snippet (代码片段)
- Function (函数)
- Template (模板)
- Document (文档)
- Config (配置)

**识别标志**:
- 有代码或模板产生
- 可复用文件生成
- 经验沉淀 (prompt 变化、复盘反思)

---

## 🔄 工作机制

### 1. 理解输入 (意图识别)

```
用户输入: "帮我处理这个CSV文件"
    ↓
意图识别:
- 任务类型: 数据处理
- 数据格式: CSV
- 操作: 处理/解析
    ↓
查询知识库:
- 历史: 之前处理过CSV吗?
- 能力: 有相关的 Skills 吗?
- 资源: 有可复用的代码吗?
    ↓
激活节点:
- 方法论: "简单优于复杂"
- Skills: "CSV文件处理"
- 副产品: parse_csv() 函数
```

**关键流程**: 意图识别 → 相关索引 → 触发激活

### 2. 指导决策 (Skills 匹配和应用)

```
多层激活:
├── L1 方法论: 指导思路
│   └── "优先使用标准库"
│
├── L2 Skills: 提供方法
│   ├── "CSV文件处理"
│   └── "错误处理模式"
│
└── L3 副产品: 提供参考
    ├── parse_csv() 函数
    └── csv_template.py
    
组合应用:
1. 遵循方法论的原则
2. 应用 Skills 的步骤
3. 参考副产品的实现
4. 生成新的输出
```

### 3. 生成输出

```
输出类型:
├── 立即输出
│   ├── 对话回复
│   └── 代码生成
│
└── 后台处理
    ├── 复盘分析
    ├── Skills 更新
    └── 副产品提取
```

### 4. 自我更新 (学习和演化)

```
更新流程:

1. 提取副产品
   ├── 识别可复用代码
   ├── 识别模板
   └── 识别经验

2. 提炼 Skills
   ├── 从多个副产品发现模式
   ├── 生成新 Skills
   └── 更新现有 Skills

3. 演化方法论 (罕见)
   ├── 从多个 Skills 提炼原则
   └── 修改现有方法论
```

---

## 🔍 关联机制

### 静态关联 (存储在图数据库)

**1. 结构关联**
```
- 方法论 → Skills (指导关系,带权重)
- Skills → 副产品 (包含关系)
- Skills → Skills (调用关系,带调用频率)
- 副产品 ← 多个 Skills (DAG 结构)
```

**存储**: Neo4j / NetworkX
**特点**: 
- 关系上可以有属性(权重、频率、成功率)
- 支持多跳查询
- 持久化存储

**3. 因果关联**
```
- 问题 → 解决方案 (学习记录)
- 失败 → 改进 (演化历史)
- 经验 → 方法论 (提炼路径)
```

### 动态关联 (查询时计算)

**2. 语义关联 (向量搜索)**
```
技术: Chroma / Weaviate / FAISS
索引: Skills 的 name + description
查询: embedding(用户输入) → Top-K 相似 Skills
```

**启动优化**: 
- 只加载 name + description (参考 Claude Code)
- 完整内容按需加载

**4. 上下文关联**
```
维护: 临时上下文向量(最近对话、当前项目)
应用: 作为向量搜索的 boost 因子
示例: 最近提到 pandas → pandas 相关 Skills 权重 +0.2
```

**5. 历史统计关联**
```
统计: Skills 共现频率
应用: 推荐系统(协同过滤)
存储: 不显式存储,通过日志分析生成
```

### 避免信息爆炸

**策略**:
1. 限制关系类型 (只保留核心关系)
2. 分层索引 (不同层用不同索引)
3. 关系强度过滤 (只保留强关系)
4. 禁止同层相似度关联 (用向量搜索代替)
5. 动态关联不持久化 (查询时计算)

---

## 🎯 查询机制

### 用户表达意图

**要求**: 清晰的情境描述

```
✅ 好的表达:
"我现在要处理一个CSV文件,包含中文,需要清洗数据"

❌ 不好的表达:
"CSV"
```

### 查询流程

```
1. 意图识别
   - 理解用户想做什么
   - 提取关键信息
   - 识别情境

2. 相关索引
   - 向量搜索 (语义相似)
   - 结构查询 (层次遍历)
   - 历史查询 (使用记录)

3. 触发激活
   - 多层激活 (方法论/Skills/副产品)
   - 按优先级排序
   - 返回最相关的
```

### 处理"没找到"

**核心能力**: 学习机会

```
场景: 用户请求处理XML文件,但系统没有相关 Skill

响应:
1. "我还没有处理XML的经验"
2. "但我可以参考CSV和JSON的处理方法"
3. "让我帮你处理,然后学习这个新能力"
4. 处理完成后,生成 "XML处理" Skill
```

---

## 📈 演化机制

### Skills 演化

```
阶段1: 诞生
- 从副产品中提炼
- 识别可复用模式
- 初始成功率: 0.5

阶段2: 成长
- 每次使用后更新
- 统计成功率
- 优化步骤

阶段3: 演化
- 发现更好的方法
- 生成新版本
- 保留演化关系

阶段4: 淘汰
- 成功率持续下降
- 被更好的 Skills 替代
- 归档但保留历史
```

### 方法论演化

```
方法论演化较慢:
- 从多个 Skills 提炼
- 需要大量验证
- 修改需要谨慎

触发条件:
- 多个 Skills 显示相同模式
- 现有方法论不再适用
- 复盘发现新的原则
```

---

## 🚀 实现路线

### Phase 1: 核心知识库 (4-6周)

```
目标: 实现三层知识库结构

任务:
├── 数据结构设计
│   ├── Methodology 节点
│   ├── Skill 节点
│   └── Artifact 节点
│
├── 存储层实现
│   ├── 图数据库 (Neo4j/NetworkX)
│   └── 向量索引 (Chroma/Weaviate)
│
└── 基础操作
    ├── 节点 CRUD
    ├── 关系管理
    └── 查询接口
```

### Phase 2: 输入输出 (4-6周)

```
目标: 实现基础的输入输出能力

任务:
├── 输入层
│   ├── 文本输入
│   ├── 意图识别
│   └── 情境理解
│
└── 输出层
    ├── 对话生成
    ├── 代码生成
    └── 复盘分析
```

### Phase 3: 自我演化 (4-6周)

```
目标: 实现 Skills 自动学习和演化

任务:
├── 副产品提取
│   ├── 代码识别
│   ├── 模板识别
│   └── 经验识别
│
├── Skills 生成
│   ├── 模式识别
│   ├── Skill 创建
│   └── 关系建立
│
└── 方法论演化
    ├── 原则提炼
    └── 方法论更新
```

---

## 🔑 关键决策

### 1. 方法论和 Skills 分开

**原因**:
- 方法论数量少,作为真理存在
- Skills 数量多,持续演化
- 方法论指导 Skills 的调用和修改

### 2. 副产品是叶子节点

**原因**:
- 清晰的层次结构
- Skills 是 parent,副产品是 leaf
- 副产品可以被多个 Skills 索引

### 3. 允许 DAG 结构

**原因**:
- 一个副产品可能适用于多个场景
- Skills 之间可能有复杂的调用关系
- 不强制严格树形,更灵活

### 4. 禁止同层相似度关联

**原因**:
- 避免信息爆炸
- 用向量搜索动态计算相似度
- 不显式存储关系

### 5. 副产品是函数级别

**原因**:
- 粒度适中,易于复用
- 不是整个文件 (太粗)
- 不是单行代码 (太细)

---

## 📝 技术栈

### 核心技术

| 层级 | 技术 | 用途 |
|------|------|------|
| **知识库** | Neo4j / NetworkX | 图数据库 |
| **向量索引** | Chroma / Weaviate | 语义搜索 |
| **LLM** | Claude / GPT / DeepSeek | 意图理解/生成 |
| **后端** | Python 3.10+ | 核心逻辑 |
| **前端** | Gradio / Tauri | UI |

### 依赖包

```txt
# 知识库
neo4j>=5.0.0
networkx>=3.0
chromadb>=0.4.0

# LLM
anthropic>=0.28.0
openai>=1.0.0

# 向量
sentence-transformers>=2.0.0

# 其他
pydantic>=2.5.0
sqlalchemy>=2.0.0
```

---

## 🎯 与原设计的对应

### 原有功能如何实现?

**知识库管理**
```
→ 知识库的核心功能
→ 不是 Extension,是系统基础
```

**生活记录**
```
→ 输入层: 实时流捕获事件
→ 知识库: 存储为事件节点
→ 输出层: 时间线展示
```

**计划管理**
```
→ 知识库: 目标和任务节点
→ Skills: "任务分解" "进度跟踪"
→ 输出层: 定时提醒和推动
```

**每日复盘**
```
→ 输出层: 复盘引擎
→ 知识库: 提取 Skills 和方法论
→ 自我演化的核心机制
```

**用户画像**
```
→ 知识库: 用户特征节点
→ 影响 Skills 匹配的优先级
→ 个性化推荐的依据
```

---

## ✅ 核心共识

1. **操作系统抽象**: 输入 + 输出 + 资源调度
2. **知识库地位**: 贯穿全局的认知基础
3. **三层结构**: 方法论 → Skills → 副产品
4. **DAG 结构**: 允许多父节点,不是严格树形
5. **关联限制**: 禁止同层相似度关联,用向量搜索
6. **演化机制**: 向上聚合,向下应用
7. **学习能力**: "没找到"是学习机会
8. **快速查找**: 认知负担小,不是响应时间快

---

**版本**: v1.0  
**最后更新**: 2026-01-18  
**状态**: 核心架构已确定,待实现
