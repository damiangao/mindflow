# Mindflow 开发指南

## 项目开发概览

本项目采用6个开发阶段的渐进式方法，总计约9-10周，涵盖MVP的所有核心功能。每个阶段都有清晰的目标、任务清单和交付物。

## MVP 范围

### 包含功能
- ✅ **生活记录**：通过对话式输入自动提取和分类生活事件
- ✅ **计划管理**：创建、跟踪和推动目标达成
- ✅ **每日复盘**：个性化的反思和总结提示
- ✅ **用户画像**：系统逐步学习用户特征，提供定制化帮助
- ✅ **灵活LLM配置**：支持Claude、GPT、DeepSeek等快速切换

### 后续扩展功能
- ⏳ 知识库管理（多模态输入、向量检索）
- ⏳ 多种通知方式（邮件、推送等）
- ⏳ 外部应用集成（Notion、Evernote等）
- ⏳ 高级分析和推荐系统

---

## Phase 1：基础框架搭建（1-2周）

### 目标
建立项目的技术基础，包括Web框架、数据库、LLM配置层和容器化部署。

### 主要任务

#### 项目结构初始化
- [ ] 创建项目目录结构
- [ ] 初始化 Git 仓库
- [ ] 创建 requirements.txt（所有依赖）
- [ ] 创建 .env.example 文件（配置示例）
- [ ] 创建 README.md（项目说明和快速开始）

#### Gradio应用框架
- [ ] 创建 `src/ui/main.py`（Gradio应用入口）
- [ ] 实现 Gradio Blocks 界面
- [ ] 创建多个Tab（生活记录、计划、复盘等）
- [ ] 验证应用可以启动和在浏览器访问

#### LLM 配置层（关键）
- [ ] 创建 `src/llm/provider.py`（抽象基类）
- [ ] 实现 `src/llm/claude.py`（Claude API）
- [ ] 实现 `src/llm/openai.py`（OpenAI API）
- [ ] 实现 `src/llm/config.py`（LLM配置管理）
- [ ] 实现环境变量配置：
  ```
  LLM_PROVIDER=claude  # 或 openai, deepseek
  CLAUDE_API_KEY=...
  OPENAI_API_KEY=...
  ```
- [ ] 编写LLM调用的测试代码

#### 数据库架构
- [ ] 创建 `src/database/connection.py`（数据库连接）
- [ ] 创建 `src/database/models.py`（SQLAlchemy ORM模型）
- [ ] 定义所有核心表的模型：
  - [ ] user_profile
  - [ ] user_behavior_features
  - [ ] events
  - [ ] plans
  - [ ] plan_updates
  - [ ] reviews
  - [ ] conversation_history
- [ ] 创建 `src/database/init_db.py`（数据库初始化脚本）
- [ ] 创建 `src/database/schemas.py`（Pydantic数据模型）

#### Docker 配置
- [ ] 创建 Dockerfile
- [ ] 创建 docker-compose.yml（如需要）
- [ ] 验证Docker镜像构建成功
- [ ] 验证Docker容器可以运行

#### 全局配置
- [ ] 创建 `src/config.py`（全局配置）
- [ ] 配置日志系统

### 交付验证清单
- [ ] ✅ 项目可以启动
- [ ] ✅ Gradio Web应用可以在浏览器访问
- [ ] ✅ 数据库可以初始化
- [ ] ✅ LLM配置可以切换并调用成功

### 交付物
- 可运行的Gradio应用骨架
- 数据库和ORM框架
- 灵活的LLM配置层
- Docker配置文件

---

## Phase 2：生活记录系统（2周）

### 目标
实现通过对话记录生活事件的核心功能，同时建立初步的用户画像系统。

### 主要任务

#### 对话界面开发
- [ ] 创建 `src/ui/components.py`（可复用的UI组件）
- [ ] 实现对话界面（gr.Chatbot组件）
- [ ] 实现对话历史显示
- [ ] 实现消息发送和接收
- [ ] 实现对话的持久化存储

#### 事件提取和存储
- [ ] 创建 `src/agents/event_agent.py`（事件提取Agent）
- [ ] 使用LangGraph定义事件提取工作流
- [ ] 实现从对话中识别和提取事件的逻辑
- [ ] 实现事件分类（work, learning, life, health, personal）
- [ ] 创建 `src/services/event_service.py`（事件服务）
- [ ] 实现事件的CRUD操作

#### 用户画像初始化
- [ ] 创建初始化问卷的UI界面
- [ ] 实现问卷数据收集
- [ ] 实现问卷数据存储到 user_profile 表

#### 用户画像更新机制
- [ ] 创建 `src/agents/user_portrait_agent.py`（用户画像Agent）
- [ ] 使用LangGraph定义用户特征学习工作流
- [ ] 实现从对话中提取用户特征的逻辑
- [ ] 创建 `src/services/user_service.py`（用户服务）
- [ ] 实现用户特征的存储和更新

#### 事件查看界面
- [ ] 创建事件列表视图（使用gr.Dataframe）
- [ ] 实现事件详情查看
- [ ] 实现按日期过滤
- [ ] 实现按类别过滤
- [ ] 实现事件编辑和删除

### 交付验证清单
- [ ] ✅ 用户首次进入系统可以填写初始问卷
- [ ] ✅ 用户可以通过对话记录生活事件
- [ ] ✅ 事件可以正确地被自动提取和分类
- [ ] ✅ 事件可以在界面上查看、编辑、删除
- [ ] ✅ 用户画像在数据库中正确初始化和更新

### 交付物
- 可用的对话界面
- 自动事件记录系统
- 用户画像数据结构和更新机制
- 生活记录Gradio UI

---

## Phase 3：计划管理系统（1.5周）

### 目标
实现完整的计划管理功能和智能推动机制。

### 主要任务

#### 计划CRUD操作
- [ ] 创建 `src/services/plan_service.py`（计划服务）
- [ ] 实现计划创建功能
- [ ] 实现计划编辑功能
- [ ] 实现计划删除功能
- [ ] 实现计划查询功能

#### 计划管理界面
- [ ] 创建计划列表视图
- [ ] 实现新建计划的表单
- [ ] 实现计划详情页面
- [ ] 实现计划编辑界面

#### 计划进度跟踪
- [ ] 实现进度百分比的更新
- [ ] 实现计划状态管理（active, completed, archived）
- [ ] 实现计划更新历史记录（plan_updates表）
- [ ] 创建进度可视化（进度条、百分比显示）

#### 计划与事件的关联
- [ ] 实现在事件中关联计划
- [ ] 实现在计划中查看相关事件
- [ ] 实现在记录事件时自动推荐相关计划

#### 计划推动Agent
- [ ] 创建 `src/agents/plan_agent.py`（计划推动Agent）
- [ ] 使用LangGraph定义计划推动工作流
- [ ] 实现基于用户画像的个性化督促建议
- [ ] 实现从生活事件推断计划进度的逻辑
- [ ] 创建 `src/prompts/plan_reminder.py`（计划提醒提示词）

#### 定时提醒机制（基础版本）
- [ ] 创建 `src/utils/scheduler.py`（任务调度）
- [ ] 实现每日计划提醒（APScheduler）
- [ ] 实现计划推动提醒的API端点

### 交付验证清单
- [ ] ✅ 用户可以创建、编辑、删除计划
- [ ] ✅ 计划可以显示进度信息
- [ ] ✅ 计划和事件可以相互关联
- [ ] ✅ 定时提醒可以触发（在日志中可见）

### 交付物
- 完整的计划管理功能
- 计划推动Agent
- 计划管理Gradio UI

---

## Phase 4：每日复盘系统（1.5周）

### 目标
实现个性化的每日复盘提示和记录系统。

### 主要任务

#### 复盘数据结构
- [ ] 复盘表的ORM模型已在Phase 1中创建
- [ ] 创建 `src/services/review_service.py`（复盘服务）

#### 复盘提示生成
- [ ] 创建 `src/prompts/review_generation.py`（复盘生成提示词）
- [ ] 创建 `src/agents/review_agent.py`（复盘生成Agent）
- [ ] 使用LangGraph定义复盘提示生成工作流
- [ ] 实现基础框架提示生成
- [ ] 实现事件相关提示生成
- [ ] 实现计划相关提示生成
- [ ] 实现用户画像驱动的个性化提示生成

#### 复盘界面开发
- [ ] 创建复盘输入界面
- [ ] 显示AI生成的复盘提示
- [ ] 用户填写复盘内容
- [ ] 用户评分（心情评分1-5）

#### 复盘历史查看
- [ ] 创建复盘历史列表视图
- [ ] 实现按日期查看复盘
- [ ] 实现复盘详情查看
- [ ] 实现复盘的基础统计（完成频率等）

#### 复盘与其他数据的关联
- [ ] 实现复盘中记录相关的事件
- [ ] 实现复盘中记录相关的计划
- [ ] 实现从生活事件和计划推断复盘内容的逻辑

### 交付验证清单
- [ ] ✅ 用户可以看到每日的个性化复盘提示
- [ ] ✅ 用户可以填写复盘内容
- [ ] ✅ 复盘记录可以保存和查看
- [ ] ✅ 复盘提示与事件、计划有正确的关联

### 交付物
- 完整的每日复盘功能
- 复盘Agent
- 复盘Gradio UI

---

## Phase 5：用户画像深化和优化（1周）

### 目标
优化用户画像系统，使系统提供更个性化的帮助。

### 主要任务

#### 用户画像分析增强
- [ ] 实现更精细的特征提取（如工作时间偏好、决策风格等）
- [ ] 实现置信度评分（confidence字段的使用）
- [ ] 实现历史对话分析，找出用户的长期特征

#### 个性化提示优化
- [ ] 根据学到的用户特征优化复盘提示的风格
- [ ] 根据学到的用户特征优化计划推动提示的强度
- [ ] 实现提示词的动态调整

#### 系统性能优化
- [ ] 数据库查询优化（添加索引等）
- [ ] LLM调用的缓存策略
- [ ] 前端响应速度优化

#### UI/UX改进
- [ ] 移动端界面优化
- [ ] 界面反馈和加载状态
- [ ] 错误提示和用户指导

### 交付验证清单
- [ ] ✅ 系统对用户的了解逐步加深（通过用户特征库）
- [ ] ✅ 提示和督促变得更个性化
- [ ] ✅ 系统性能稳定

### 交付物
- 更智能的用户画像系统
- 更个性化的AI助理体验

---

## Phase 6：部署和扩展准备（1周）

### 目标
将系统准备好部署到生产环境，并为未来扩展奠定基础。

### 主要任务

#### 部署准备
- [ ] Docker镜像优化和压缩
- [ ] 部署到Linux服务器的脚本和指南
- [ ] 环境变量配置说明（API keys等）
- [ ] 数据库备份脚本

#### 文档编写
- [ ] 部署文档（DEPLOYMENT.md）
- [ ] 用户指南（USER_GUIDE.md）
- [ ] API文档（如有）
- [ ] LLM配置文档（LLM_CONFIG.md）
- [ ] 数据库schema文档（DATABASE.md）
- [ ] 用户画像设计文档（USER_PORTRAIT.md）

#### 测试
- [ ] 单元测试（agents, services）
- [ ] 集成测试（端到端流程）
- [ ] 部署测试（在Linux环境下测试）

#### 未来扩展的接口预留
- [ ] 知识库功能的接口预留
- [ ] 多模态输入的接口预留
- [ ] 通知系统的接口预留

### 交付验证清单
- [ ] ✅ 系统可以部署到Linux服务器
- [ ] ✅ 所有功能正常运行
- [ ] ✅ 文档完整清晰
- [ ] ✅ 用户可以快速配置和使用

### 交付物
- 可部署的生产版本
- 完整部署和用户文档
- 清晰的扩展路线图

---

## 开发最佳实践

### 架构原则
1. **模块化**：各功能相对独立，便于维护和扩展
2. **分离关注点**：UI、业务逻辑、数据访问层清晰分离
3. **可测试性**：每个模块都应该可以独立测试

### 代码组织
```
src/
├── ui/                 # 前端UI组件
│   ├── main.py
│   └── components.py
├── agents/             # LangGraph Agents
│   ├── event_agent.py
│   ├── user_portrait_agent.py
│   ├── plan_agent.py
│   └── review_agent.py
├── services/           # 业务逻辑层
│   ├── event_service.py
│   ├── user_service.py
│   ├── plan_service.py
│   └── review_service.py
├── database/           # 数据库相关
│   ├── connection.py
│   ├── models.py
│   ├── schemas.py
│   └── init_db.py
├── llm/                # LLM配置和调用
│   ├── provider.py
│   ├── claude.py
│   ├── openai.py
│   └── config.py
├── prompts/            # 提示词管理
│   ├── plan_reminder.py
│   └── review_generation.py
├── utils/              # 工具函数
│   └── scheduler.py
└── config.py           # 全局配置
```

### 开发流程
1. 在开始Phase之前，确保前一个Phase的所有任务都已完成
2. 为每个功能写测试
3. 在提交代码前运行测试
4. 定期提交代码，保持git历史清晰

### 测试策略
- **单元测试**：测试individual functions和methods
- **集成测试**：测试不同组件之间的交互
- **端到端测试**：测试完整的用户工作流

---

## 技术决策参考

### 为什么选择这些技术？

**Gradio**
- 快速搭建Web UI
- 自动生成响应式界面（PC和移动端）
- 简化前后端集成
- 学习曲线平缓

**LangGraph**
- 强大的Agent工作流能力
- 清晰的状态管理
- 支持复杂的多步骤流程
- 与LLM API无缝集成

**SQLite（MVP）**
- MVP阶段足够
- 零配置，易于部署
- 无需服务器
- 支持后续升级到PostgreSQL

**Agent架构**
- 清晰的职责划分
- 易于测试和维护
- 支持独立演进
- 便于添加新功能

---

## 常见问题

### 如何切换LLM？
修改环境变量：
```bash
export LLM_PROVIDER=openai
export OPENAI_API_KEY=your_key
```

### 数据库升级到PostgreSQL需要哪些步骤？
1. 修改数据库连接字符串
2. 迁移SQLite数据到PostgreSQL
3. 测试所有功能
4. 更新Docker配置

### 如何添加新功能？
1. 确定功能属于哪个模块（或创建新模块）
2. 创建相应的Agent（如需要）
3. 实现服务层逻辑
4. 添加UI组件
5. 编写测试

---

## 下一步

开始Phase 1的开发。按照检查清单逐项完成任务。
